---
title: "065 - RGB Balls 2（★7）"
---

[065 \- RGB Balls 2（★7）](https://atcoder.jp/contests/typical90/tasks/typical90_bm)


# アルゴリズム

## 問題 - 入力例1

問題の入力例1について、まず考えます。

* 赤・緑・青のボールがそれぞれ (R, G, B) = (3, 1, 2) 個ある
* ボールを全部で K = 5 個選ぶ
* 赤・緑のボールの合計は X = 4 以下
* 緑・青のボールの合計は Y = 2 以下
* 青・赤のボールの合計は Z = 4 以下

## 2色の組み合わせ条件を1色に減らす - 入力例1

> 赤・青のボールの合計は X = 4 以下

赤と青の合計が 4 以下という条件では、赤の個数に応じて青の個数が決まります。しかし、これでは 2色の組み合わせを個別に考える必要があり、複雑になります。

条件を単純化するため、「赤・青のボールの合計」を「緑のボールの数」に置き換えます。

ボールを全部で K = 5 個選びます。ここで、赤と青で合計 4 個以下 という条件は、言い換えると「緑のボールを 1 個以上使う」ことになります。

* 赤・緑のボールの合計は X = 4 個以下
* 緑・青のボールの合計は Y = 2 個以下
* 青・赤のボールの合計は Z = 4 個以下

これらの条件を「最低限必要な各色のボールの個数」として表現し直すと、次のようになります。

* 青のボールは X' = 1 個以上
* 赤のボールは Y' = 3 個以上
* 緑のボールは Z' = 1 個以上

「赤・緑・青のボールがそれぞれ (R, G, B) = (3, 1, 2) 個ある」でした。組み合わせると次のようになります。

* 赤のボールは Y' = 3 個以上、かつ R = 3 個以下
* 緑のボールは Z' = 1 個以上、かつ G = 1 個以下
* 青のボールは X' = 1 個以上、かつ B = 2 個以下

それぞれのボールの個数はこの範囲内に収まり、合計が 5 個になるように選びます。


||0|1|2|3|
|---|---|---|---|---|
|赤|-|-|-|🔴|
|緑|-|🟢|-|-|
|青|-|🔵|🔵|-|


## 組み合わせを考える - 入力例1

> * 赤のボールは Y' = 3 個以上、R = 3 個以下
> * 緑のボールは Z' = 1 個以上、G = 1 個以下

したがって、赤と緑のボールはすべて選ぶことになります。

> * 青のボールは X' = 1 個以上、B = 2 個以下

青のボールは最大 2 個まで選べますが、すでに赤と緑で 合計 4 個 を選んでいるため、残り 1 個しか選べません。

したがって、2 個ある青のボールから 1 個を選ぶ組み合わせは、次のようになります。

$$_2C_1 = 2$$

|赤の個数|緑の個数|青の個数|赤の組み合わせ|緑の組み合わせ|青の組み合わせ|合計|
|---|---|---|---|---|---|---|
|3|1|✅1|$_3C_3 = 1$|$_1C_1 = 1$|$_2C_1 = 2$|$1*1*2=2$|

つまり、2 通りの選び方があることになります。


## 問題 - 入力例2

先ほどより難しい問題を考えます。この問題は、公式解説スライドで扱われたものと同じ内容です。

* 赤・緑・青のボールがそれぞれ (R, G, B) = (5, 5, 6) 個ある
* ボールを全部で K = 10 個選ぶ
* 赤・緑のボールの合計は X = 7 以下
* 緑・青のボールの合計は Y = 8 以下
* 青・赤のボールの合計は Z = 9 以下

## 2色の組み合わせ条件を1色に減らす - 入力例2

入力例1と同様に、2色の合計で表されている条件を1色に置き換えます。ここでは、「赤・青のボールの合計」を「緑のボールの数」に変換します。すると、次のようになります。

* 青のボールは X' = 3 個以上
* 赤のボールは Y' = 2 個以上
* 緑のボールは Z' = 1 個以上

ボールの数 (5, 5, 6) と組み合わせると、次のようになります。

* 赤のボールは Y' = 2 個以上、R = 5 個以下
* 緑のボールは Z' = 1 個以上、G = 5 個以下
* 青のボールは X' = 3 個以上、B = 6 個以下

||0|1|2|3|4|5|6|
|---|---|---|---|---|---|---|---|
|赤|-|-|🔴|🔴|🔴|🔴|-|
|緑|-|🟢|🟢|🟢|🟢|🟢|-|
|青|-|-|-|🔵|🔵|🔵|🔵|

## 組み合わせを考える - 入力例2

入力例1 と同じように計算します。

|赤の個数|緑の個数|青の個数|赤の組み合わせ|緑の組み合わせ|青の組み合わせ|合計|
|---|---|---|---|---|---|---|
|2|1|❌7|${}_5C_2 = 10$|${}_5C_1 = 5$|$0$|$0$|
|2|2|✅6|${}_5C_2 = 10$|${}_5C_2 = 10$|${}_6C_6 = 1$|$10*10*1=100$|
|2|3|✅5|${}_5C_2 = 10$|${}_5C_3 = 10$|${}_6C_5 = 6$|$10*10*6=600$|
|2|4|✅4|${}_5C_2 = 10$|${}_5C_4 = 5$|${}_6C_4 = 15$|$10*5*15=750$|
|2|5|✅3|${}_5C_2 = 10$|${}_5C_5 = 1$|${}_6C_3 = 20$|$10*5*15=200$|
|3|1|✅6|${}_5C_3 = 10$|${}_5C_1 = 5$|${}_6C_6 = 1$|$10*5*1=50$|
|3|2|✅5|${}_5C_3 = 10$|${}_5C_2 = 10$|${}_6C_5 = 6$|$10*10*6=600$|
|3|3|✅4|${}_5C_3 = 10$|${}_5C_3 = 10$|${}_6C_4 = 15$|$10*10*15=1500$|
|3|4|✅3|${}_5C_3 = 10$|${}_5C_4 = 5$|${}_6C_3 = 20$|$10*5*20=1000$|
|3|5|❌2|${}_5C_3 = 10$|${}_5C_5 = 1$|$0$|$0$|
|4|1|✅5|${}_5C_4 = 5$|${}_5C_1 = 5$|${}_6C_5 = 6$|$5*5*6=150$|
|4|2|✅4|${}_5C_4 = 5$|${}_5C_2 = 10$|${}_6C_4 = 15$|$5*10*15=750$|
|4|3|✅3|${}_5C_4 = 5$|${}_5C_3 = 10$|${}_6C_3 = 20$|$5*10*20=1000$|
|4|4|❌2|${}_5C_4 = 5$|${}_5C_4 = 5$|$0$|$0$|
|4|5|❌1|${}_5C_4 = 5$|${}_5C_5 = 1$|$0$|$0$|
|5|1|✅4|${}_5C_5 = 1$|${}_5C_1 = 5$|${}_6C_4 = 15$|$1*5*15=75$|
|5|2|✅3|${}_5C_5 = 1$|${}_5C_2 = 10$|${}_6C_3 = 20$|$1*10*20=200$|
|5|3|❌2|${}_5C_5 = 1$|${}_5C_3 = 10$|$0$|$0$|
|5|4|❌1|${}_5C_5 = 1$|${}_5C_4 = 5$|$0$|$0$|
|5|5|❌0|${}_5C_5 = 1$|${}_5C_5 = 1$|$0$|$0$|

$$
100+600+750+200+50+600+1500+1000+150+750+1000+75+200=6975
$$

合計すると 6975 になります。これが答えです。

入力例2くらいならこのように計算できます。しかし、組み合わせ数が増えると制限時間内に間に合わなくなります。


## 畳み込みで高速化する

前の表では、${}_6C_6 = 1$ などの同じ式が繰り返し現れていました。計算の順序を工夫すれば、より高速化できそうです。

赤・緑・青の3つの個数に対応する表です:

||緑1|緑2|緑3|緑4|緑5|
|---|---|---|---|---|---|
|赤2|❌3️⃣青7|✅4️⃣青6|✅5️⃣青5|✅6️⃣青4|✅7️⃣青3|
|赤3|✅4️⃣青6|✅5️⃣青5|✅6️⃣青4|✅7️⃣青3|❌8️⃣青2|
|赤4|✅5️⃣青5|✅6️⃣青4|✅7️⃣青3|❌8️⃣青2|❌9️⃣青1|
|赤5|✅6️⃣青4|✅7️⃣青3|❌8️⃣青2|❌9️⃣青1|❌🔟青0|

次に、赤・緑・青の3つの組み合わせ数に対応する表です:

||緑${}_5C_1$|緑${}_5C_2$|緑${}_5C_3$|緑${}_5C_4$|緑${}_5C_5$|
|---|---|---|---|---|---|
|赤${}_5C_2$|3️⃣❌|4️⃣青${}_6C_6$|5️⃣青${}_6C_5$|6️⃣青${}_6C_4$|7️⃣青${}_6C_3$|
|赤${}_5C_3$|4️⃣青${}_6C_6$|5️⃣青${}_6C_5$|6️⃣青${}_6C_4$|7️⃣青${}_6C_3$|8️⃣❌|
|赤${}_5C_4$|5️⃣青${}_6C_5$|6️⃣青${}_6C_4$|7️⃣青${}_6C_3$|8️⃣❌|9️⃣❌|
|赤${}_5C_5$|6️⃣青${}_6C_4$|7️⃣青${}_6C_3$|8️⃣❌|9️⃣❌|🔟❌|

(赤, 緑, 青) = (3, 1, 4) 個の時の組み合わせは、 赤${}_5C_3$ * 緑${}_5C_1$ * ️4️⃣青${}_6C_6$ = ${}_5C_3 * {}_5C_1 * {}_6C_6$ です。

斜め右上方向に同じ数字 4️⃣ が並んでいます。これは赤と緑の合計数を表しています。

先に 4️⃣ が入っている2つのマスの合計を求めると、後から ${}_6C_6$ を1回掛け算することで、全体の合計値を求めることができます。

他の枠付きの数字についても、同じ枠付きの数字を同じ行に並べるように、表を整理します:

|赤+緑の個数|青の個数|赤+緑の組み合わせ|青の組み合わせ|組み合わせ|
|---|---|---|---|---|
|3️⃣|❌7|${}_5C_2 \cdot {}_5C_1$|$0$|$0$|
|4️⃣|✅6|${}_5C_2 \cdot {}_5C_2 + {}_5C_3 \cdot {}_5C_1$|${}_6C_6$|$150 \times 1$|
|5️⃣|✅5|${}_5C_2 \cdot {}_5C_3 + {}_5C_3 \cdot {}_5C_2 + {}_5C_4 \cdot {}_5C_1$|${}_6C_5$|$225 \times 6$|
|6️⃣|✅4|${}_5C_2 \cdot {}_5C_4 + {}_5C_3 \cdot {}_5C_3 + {}_5C_4 \cdot {}_5C_2 + {}_5C_5 \cdot {}_5C_1$|${}_6C_4$|$205 \times 15$|
|7️⃣|✅3|${}_5C_2 \cdot {}_5C_5 + {}_5C_3 \cdot {}_5C_4 + {}_5C_4 \cdot {}_5C_3 + {}_5C_5 \cdot {}_5C_2$|${}_6C_3$|$120 \times 20$|
|8️⃣|❌2|${}_5C_3 \cdot {}_5C_5 + {}_5C_4 \cdot {}_5C_4 + {}_5C_5 \cdot {}_5C_3$|$0$|$0$|
|9️⃣|❌1|${}_5C_4 \cdot {}_5C_5 + {}_5C_5 \cdot {}_5C_4$|$0$|$0$|
|🔟|❌0|${}_5C_5 \cdot {}_5C_5$|$0$|$0$|

$150 \times 1 + 225 \times 6 + 205 \times 15 + 120 \times 20 = 6975$ です。先ほどよりも高速に計算できそうです。この方法を用いることで、満点解答を得られます。

赤 + 緑 の組み合わせの計算は一見複雑ですが、畳み込み演算を用いることで一括で求めることができます。AtCoder Library の convolution をそのまま利用できます。

* [atcoder\.github\.io/ac\-library/production/document\_ja/convolution\.html](https://atcoder.github.io/ac-library/production/document_ja/convolution.html)
* [convolution in ac\_library::convolution \- Rust](https://docs.rs/ac-library-rs/latest/ac_library/convolution/fn.convolution.html)

|🔴|$a_0$|$a_1$|$a_2$|$a_3$|$a_4$|$a_5$|
|---|---|---|---|---|---|---|
|値|$0$|$0$|${}_5C_2$|${}_5C_3$|${}_5C_4$|${}_5C_5$|

|🟢|$b_0$|$b_1$|$b_2$|$b_3$|$b_4$|$b_5$|
|---|---|---|---|---|---|---|
|値|$0$|${}_5C_1$|${}_5C_2$|${}_5C_3$|${}_5C_4$|${}_5C_5$|

2つの配列を畳み込み演算した結果、次のような結果が得られます。

|畳み込み|式||||||結果|
|---|---|---|---|---|---|---|---|
|0️⃣$c_0$|$=a_0 b_0$||||||$=0$|
|     |$0 \cdot 0$|||||||
|1️⃣$c_1$|$=a_0 b_1$|$+a_1 b_0$|||||$=0$|
|     |$0 \cdot {}_5C_1$|$0 \cdot 0$|
|2️⃣$c_2$|$=a_0 b_2$|$+a_1 b_1$|$+a_2 b_0$||||$=0$|
|     |$0 \cdot {}_5C_2$|$0 \cdot {}_5C_1$|${}_5C_2\cdot 0$|
|3️⃣$c_3$|$=a_0 b_3$|$+a_1 b_2$|+$a_2 b_1$|+$a_3 b_0$|||$=50$|
|     |$0 \cdot {}_5C_3$|$0 \cdot {}_5C_2$|${}_5C_2\cdot {}_5C_1$|${}_5C_3\cdot 0$|
|4️⃣$c_4$|$a_0 b_4$|$a_1 b_3$|$a_2 b_2$|$a_3 b_1$|$a_4 b_0$||$=150$
|     |$0 \cdot {}_5C_4$|$0 \cdot {}_5C_3$|${}_5C_2\cdot {}_5C_2$|${}_5C_3\cdot {}_5C_1$|${}_5C_4\cdot 0$|
|5️⃣$c_5$|$a_0 b_5$|$a_1 b_4$|$a_2 b_3$|$a_3 b_2$|$a_4 b_1$|$a_5 b_0$|$=225$
|     |$0 \cdot {}_5C_5$|$0 \cdot {}_5C_4$|${}_5C_2\cdot {}_5C_3$|${}_5C_3\cdot {}_5C_2$|${}_5C_4\cdot {}_5C_1$|${}_5C_5\cdot 0$|
|6️⃣$c_6$|$a_1 b_5$|$a_2 b_4$|$a_3 b_3$|$a_4 b_2$|$a_5 b_1$||$=205$|
|     |$0 \cdot {}_5C_5$|${}_5C_2\cdot {}_5C_4$|${}_5C_3\cdot {}_5C_3$|${}_5C_4\cdot {}_5C_2$|${}_5C_5\cdot {}_5C_1$|
|7️⃣$c_7$|$a_2 b_5$|$a_3 b_4$|$a_4 b_3$|$a_5 b_2$|||$=120$|
|     |${}_5C_2\cdot {}_5C_5$|${}_5C_3\cdot {}_5C_4$|${}_5C_4\cdot {}_5C_3$|${}_5C_5\cdot {}_5C_2$|
|8️⃣$c_8$|$a_3 b_5$|$a_4 b_4$|$a_5 b_3$||||$=45$|
|     |${}_5C_3\cdot {}_5C_5$|${}_5C_4\cdot {}_5C_4$|${}_5C_5\cdot {}_5C_3$|
|9️⃣$c_9$|$a_4 b_5$|$a_5 b_4$|||||$=10$|
|     |${}_5C_4\cdot {}_5C_5$|${}_5C_5\cdot {}_5C_4$|
|🔟$c_{10}$|$a_5 b_5$||||||$=1$|
|     |${}_5C_5\cdot {}_5C_5$|

畳み込みを行い、その後、青のボールとの組み合わせを計算する部分は、以下のような Rust コードで実装できます。

```rust
let rgs = convolution(&rs, &gs);

let mut result = Mint::new(0);
for ib in 0..=(b1 - b0) {
    let i = k - (r0 + g0 + b0 + ib);
    result += rgs[i] * bs[ib];
}
```

お疲れさまでした。

## 組み合わせと余り

組み合わせの数は、次の式で求められます。

$${}_nC_r = \frac{n!}{r!(n-r)!}$$

この問題では組み合わせの数が非常に大きくなるため、998244353 で割った余りを解答として求めます。

毎回階乗を計算すると処理が遅くなるため、事前に階乗とその逆数を計算し、配列に保存しておくのが効率的です。こうすることで、組み合わせの計算は、事前に計算した $n!$, $1/r!$, $1/(n-r)!$ の3つの値をかけ合わせるだけで、高速に行えます。

||0|1|2|3|4|5|...|
|---|---|---|---|---|---|---|---|
|$n!$|1|1|2|6|24|120|
|$1/n!$|1|1|499122177|166374059|291154603|856826403|

```rust

fn build_fact(n: usize) -> Vec<Mint> {
    let mut fact = vec![Mint::new(1); n + 1];
    for i in 2..=n {
        fact[i] = fact[i - 1] * i;
    }
    fact
}

fn build_fact_inv(fact: &[Mint]) -> Vec<Mint> {
    let n = fact.len() - 1;
    let mut fact_inv = vec![Mint::new(1); n + 1];
    for i in 0..=n {
        fact_inv[i] = fact[i].inv();
    }
    fact_inv
}
```


# 実装例

## 畳み込みなし (TLE)
https://github.com/hossy3/atcoder-solutions/blob/main/atcoder/typical90/src/bin/065_combination_2_tle.rs

## 畳み込みあり
https://github.com/hossy3/atcoder-solutions/blob/main/atcoder/typical90/src/bin/065_convolution.rs
