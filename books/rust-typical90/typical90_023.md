---
title: "023 - Avoid War（★7）"
---

[023 \- Avoid War（★7）](https://atcoder.jp/contests/typical90/tasks/typical90_w)


# アルゴリズム

## 方針: 2次元DPの状態更新について

👑キングの周辺 8マスにほかのキングがあってはいけません。左上から順に状態を埋めていくと、一見 🔍 4つの 16状態だけから 👑 の状態が分かりそうに思います。

|||||||
|---|---|---|---|---|---|
||🔍|🔍|🔍|||
||🔍A|👑B||||
|||||||

👑B までのマスを左上から埋める状態数は、🔍A までのマスを左上から埋める状態数以上のはずです。

しかしこの方針では、うまく状態を混ぜることができません。

|||||||
|---|---|---|---|---|---|
|||||||
|🔍|🔍A|🔍B||||
|🔍|👑C|||||

|||||||
|---|---|---|---|---|---|
|||||||
||🔍A|🔍B|🔍|||
||🔍C|👑D||||

👑C までのマスを左上から埋める状態数は、🔍A までのマスを左上から埋める状態数以上のはずです。

👑D までのマスを左上から埋める状態数は、🔍B, 🔍C までのマスを埋める状態数以上です。B, C がそれぞれ別の依存関係で増えていると、D の状態数が分かりません。

2か所で状態数が増えると混ぜられません。状態が同じ規則で増え続けるようにします。たとえば 1つ上の行の状態を覚えるようにして、今調べている行も順次更新していく感じです。

|||||||
|---|---|---|---|---|---|
|||||||
|🗒️🔍|🗒️🔍|🗒️🔍|🗒️|🗒️|🗒️|
|📝🔍|👑C|||||

|||||||
|---|---|---|---|---|---|
|||||||
|🗒️|🗒️🔍|🗒️🔍|🗒️🔍|🗒️|🗒️|
|📝|📝🔍C|👑D||||

または行単位ではなく、今後参照することのある w + 1 個だけ覚える方法にします。こちらの方が効率的です。

|||||||
|---|---|---|---|---|---|
|||||||
|🗒️🔍|🗒️🔍|🗒️🔍|🗒️|🗒️|🗒️|
|🗒️🔍|👑C|||||

|||||||
|---|---|---|---|---|---|
|||||||
||🗒️🔍|🗒️🔍|🗒️🔍|🗒️|🗒️|
|🗒️|🗒️🔍C|👑D||||

## Bit DP / 行単位

```
.#.
#..
.##
```

1行目 `.#.` のキングの配置方法は `.#.`, `.#o`, `o#.`, `o#o` の 4通りあります。キングがあるところのビットを立てるように `0b000`, `0b001`, `0b100`, `0b101` と考えます。それぞれ 1通りです。

```mermaid
graph TD;
subgraph Row1
1_0(000:1)
1_1(001:1)
1_4(100:1)
1_5(101:1)
end
subgraph Row2
2_0(000:4)
2_1(001:2)
2_2(010:1)
end
subgraph Row3
3_0(000:7)
3_4(100:6)
end

1_0 -- ".#.
#.." --> 2_0
1_0 -- ".#.
#.o" --> 2_1
1_0 -- ".#.
#o." --> 2_2
1_1 -- ".#o
#.." --> 2_0
1_4 -- "o#.
#.." --> 2_0
1_4 -- "o#.
#.o" --> 2_1
1_5 -- "o#o
#.." --> 2_0

2_0 -- "#..
.##" --> 3_0
2_0 -- "#..
o##"  --> 3_4
2_1 -- "#.o
.##"  --> 3_0
2_1 -- "#.o
o##"  --> 3_4
2_2 -- "#o.
.##"  --> 3_0
```

最後の行が埋まると、全状態数は 6+7 = 13 になります。

各行の状態数は 1行が 24列あると一見 2^24 そうですが、キングが隣り合わないため小さくなります。これでだいたい DP できます。

24×24 すべて配置可能な場合だけはとても重く、TLE します。決め打ちで答え `253474685` を入れてもと思いたくなるくらいです……。


## Bit DP / w + 1 個履歴管理

```
.#.
#..
.##
```

同じ盤面を 1マスずつ更新します。 `?` は考えなくて良いマスを表します。4マス分の履歴があれば、次のマスの状態数を求められます。

```mermaid
graph TD;
subgraph r0_c0
0_0_0("`0000:1
...
.??
`")
0_0_1("`0001:1
...
o??
`")
end

subgraph r0_c1
0_1_0("`0000:1
?..
.#?`")
0_1_2("`0010:1
?..
o#?`")
end
0_0_0--> 0_1_0
0_0_1--> 0_1_2

subgraph r0_c2
0_2_0("`0000:1
??.
.#.`")
0_2_1("`0001:1
??.
.#o`")
0_2_4("`0100:1
??.
o#.`")
0_2_5("`0101:1
??.
o#o`")
end
0_1_0 --> 0_2_0
0_1_0 -- o --> 0_2_1
0_1_2 --> 0_2_4
0_1_2 -- o --> 0_2_5

subgraph r1_c0
1_0_0("`0000:1
.#.
#??`")
1_0_2("`0010:1
.#o
#??`")
1_0_8("`1000:1
o#.
#??`")
1_0_a("`1010:1
o#o
#??`")
end
0_2_0 --> 1_0_0
0_2_1 --> 1_0_2
0_2_4 --> 1_0_8
0_2_5 --> 1_0_a

subgraph r1_c1
1_1_0("`0000:2
?#.
#.?`")
1_1_1("`0001:1
?#.
#o?`")
1_1_4("`0100:2
?#o
#o?`")
end
1_0_0 --> 1_1_0
1_0_0 -- o --> 1_1_1
1_0_2 --> 1_1_4
1_0_8 -- o --> 1_1_1
1_0_a --> 1_1_4

subgraph r1_c2
1_2_0("`0000:2
??.
#..`")
1_2_1("`0001:2
??.
#.o`")
1_2_2("`0010:1
??.
#o.`")
1_2_8("`1000:2
??o
#..`")
end
1_1_0 --> 1_2_0
1_1_0 -- o --> 1_2_1
1_1_1 --> 1_2_2
1_1_4 --> 1_2_8

subgraph r2_c0
2_0_0("`0000:4
#..
.??`")
2_0_1("`0001:4
#..
o??`")
2_0_2("`0010:2
#.o
.??`")
2_0_3("`0011:2
#.o
o??`")
2_0_4("`0100:1
#o.
.??`")
end
1_2_0 --> 2_0_0
1_2_0 -- o --> 2_0_1
1_2_1 --> 2_0_2
1_2_1 -- o --> 2_0_3
1_2_2 --> 2_0_4
1_2_8 --> 2_0_0
1_2_8 -- o --> 2_0_1

subgraph r2_c1
2_1_0("`0000:4
?..
.#?`")
2_1_2("`0010:4
?..
o#?`")
2_1_4("`0100:2
?.o
.#?`")
2_1_6("`0110:2
?.o
o#?`")
2_1_8("`1000:1
?o.
.#?`")
end
2_0_0 --> 2_1_0
2_0_1 --> 2_1_2
2_0_2 --> 2_1_4
2_0_3 --> 2_1_6
2_0_4 --> 2_1_8

subgraph r2_c2
2_2_0("`0000:5
??.
.##`")
2_2_4("`0100:4
??.
o##`")
2_2_8("`1000:2
??o
.##`")
2_2_c("`1100:2
??o
o##`")
end
2_1_0 --> 2_2_0
2_1_2 --> 2_2_4
2_1_4 --> 2_2_8
2_1_6 --> 2_2_c
2_1_8 --> 2_2_0
```

遷移数が増えましたが、それぞれのノードから矢印が 1本か 2本延びるだけと思うと、計算量はより軽いです。


# 実装例

## Bit DP / 行単位 (TLE)
https://github.com/hossy3/atcoder-solutions/blob/main/atcoder/typical90/src/bin/023_bit_dp_row_tle.rs

## Bit DP / w + 1 個履歴管理
https://github.com/hossy3/atcoder-solutions/blob/main/atcoder/typical90/src/bin/023_bit_dp_w_plus_1.rs
